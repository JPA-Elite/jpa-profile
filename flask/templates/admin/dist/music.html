{% extends "admin/dist/layout.html" %}

{% block title %}Admin | Music{% endblock %}

{% block content %}
<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Music</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Maintenance</li>
          <li class="breadcrumb-item active" aria-current="page">Music</li>
        </ol>
      </div>
    </div>
  </div>
</div>
<div class="app-content">
  <div class="container-fluid">
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Music List</h3>
          </div>
          <div class="card-body">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Artist</th>
                  <th>Preview</th>
                  <th>Image</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="musicTableBody">
                <!-- Default loading row -->
                <tr>
                  <td colspan="6" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>

            <!-- ✅ Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <button id="prevPage" class="btn btn-outline-secondary btn-sm">Prev</button>
              <span id="pageInfo"></span>
              <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
            </div>

            <div id="musicModals"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  const perPage = 10;

  async function loadMusic(page = 1) {
    const tbody = document.getElementById("musicTableBody");
    const modalContainer = document.getElementById("musicModals");
    const pageInfo = document.getElementById("pageInfo");

    // ✅ Show loading row
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
    modalContainer.innerHTML = "";

    try {
      const response = await fetch(`/admin/api/music-list?page=${page}&per_page=${perPage}&order=desc`);
      const data = await response.json();

      tbody.innerHTML = ""; // clear loading
      modalContainer.innerHTML = "";

      if (!data.music || data.music.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">No music found</td></tr>`;
        pageInfo.textContent = `Page ${page}`;
        return;
      }

      data.music.forEach((music, index) => {
        const modalIdEdit = `editModal${page}_${index}`;
        const modalIdDelete = `deleteModal${page}_${index}`;

        // ✅ Add table row
        tbody.innerHTML += `
        <tr>
          <td>${(page - 1) * perPage + (index + 1)}</td>
          <td>${music.title}</td>
          <td>${music.artist}</td>
          <td class="text-center">
            <a href="${music.url}" target="_blank" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-music-note-beamed"></i> Preview
            </a>
          </td>
          <td class="text-center">
            <img src="${music.image}" alt="${music.title}" style="width: 60px; height: auto; border-radius:4px;">
          </td>
          <td>
            <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#${modalIdEdit}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#${modalIdDelete}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        `;

        // ✅ Add Edit modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdEdit}" tabindex="-1" aria-labelledby="${modalIdEdit}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdEdit}Label">Edit Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editForm${page}_${index}">
                  <div class="mb-3">
                    <label for="editTitle${page}_${index}" class="form-label">Title</label>
                    <input type="text" class="form-control" id="editTitle${page}_${index}" value="${music.title}">
                  </div>
                  <div class="mb-3">
                    <label for="editArtist${page}_${index}" class="form-label">Artist</label>
                    <input type="text" class="form-control" id="editArtist${page}_${index}" value="${music.artist}">
                  </div>
                  <div class="mb-3">
                    <label for="editUrl${page}_${index}" class="form-label">Music URL</label>
                    <input type="text" class="form-control" id="editUrl${page}_${index}" value="${music.url}">
                  </div>
                  <div class="mb-3">
                    <label for="editImage${page}_${index}" class="form-label">Image URL</label>
                    <input type="text" class="form-control" id="editImage${page}_${index}" value="${music.image}">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save changes</button>
              </div>
            </div>
          </div>
        </div>
        `;

        // ✅ Add Delete modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdDelete}" tabindex="-1" aria-labelledby="${modalIdDelete}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdDelete}Label">Delete Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete <strong>${music.title}</strong> by <em>${music.artist}</em>?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Delete</button>
              </div>
            </div>
          </div>
        </div>
        `;
      });

      // ✅ Update page info
      pageInfo.textContent = `Page ${page}`;
      document.getElementById("prevPage").disabled = page <= 1;
      document.getElementById("nextPage").disabled = data.music.length < perPage;

    } catch (error) {
      console.error("Error fetching music list:", error);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadMusic(currentPage);

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        loadMusic(currentPage);
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      loadMusic(currentPage);
    });
  });
</script>
{% endblock %}