{% extends "admin/dist/layout.html" %}

{% block title %}Admin | Music{% endblock %}

{% block content %}
<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Music</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Maintenance</li>
          <li class="breadcrumb-item active" aria-current="page">Music</li>
        </ol>
      </div>
    </div>
  </div>
</div>
<div class="app-content">
  <div class="container-fluid">
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Music List</h3>
            <div class="mb-3 text-end">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMusicModal">
                <i class="bi bi-plus-circle"></i> Add Music
              </button>
            </div>
            <!-- Add Modal -->
            <div class="modal fade" id="addMusicModal" tabindex="-1" aria-labelledby="addMusicModalLabel"
              aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Add New Music</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="addMusicForm">
                      <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addTitle" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Artist <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addArtist" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Music File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="addMusicFile" accept="audio/*" required>
                      </div>
                      <!-- Desktop (Drag & Drop) -->
                      <div class="mb-3 d-none d-md-block">
                        <label class="form-label">Image File <span class="text-danger">*</span></label>
                        <div id="addDropZone" class="dropzone">
                          <p>Drag & Drop image here, or click to select</p>
                          <input type="file" id="addImageFile" accept="image/*" hidden required>
                        </div>
                      </div>

                      <!-- Mobile (Normal Input) -->
                      <div class="mb-3 d-md-none">
                        <label class="form-label">Image File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="addImageFileMobile" accept="image/*" required>
                      </div>

                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="addMusicBtn"
                      data-loading-text='<span class="spinner-border spinner-border-sm me-2"></span> Saving...'
                      onclick="addMusic()">
                      Save
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Artist</th>
                  <th>Preview</th>
                  <th>Image</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="musicTableBody">
                <!-- Default loading row -->
                <tr>
                  <td colspan="6" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>

            <!-- âœ… Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <button id="prevPage" class="btn btn-outline-secondary btn-sm">Prev</button>
              <span id="pageInfo"></span>
              <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
            </div>

            <div id="musicModals"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let currentAudio = null;
  let currentButton = null;
  const perPage = 10;

  function setButtonLoading(button, isLoading) {
    if (!button) return;

    if (isLoading) {
      button.dataset.originalText = button.innerHTML; // Save original
      button.innerHTML = button.dataset.loadingText || "Loading...";
      button.disabled = true;
    } else {
      button.innerHTML = button.dataset.originalText || "Save";
      button.disabled = false;
    }
  }

  function initDropZone(dropZoneId, inputId) {
    const dropZone = document.getElementById(dropZoneId);
    const inputEl = document.getElementById(inputId);

    if (!dropZone || !inputEl) return;

    dropZone.addEventListener("click", () => inputEl.click());

    ["dragenter", "dragover"].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();   // âœ… stop modal/backdrop from stealing event
        dropZone.classList.add("dragover");
      });
    });

    dropZone.addEventListener("dragleave", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove("dragover");

      if (e.dataTransfer.files.length > 0) {
        inputEl.files = e.dataTransfer.files;
        dropZone.querySelector("p").textContent = e.dataTransfer.files[0].name;
      }
    });

    inputEl.addEventListener("change", () => {
      if (inputEl.files.length > 0) {
        dropZone.querySelector("p").textContent = inputEl.files[0].name;
      }
    });
  }

  function togglePreview(musicId, musicUrl) {
    const audioEl = document.getElementById(`audio_${musicId}`);
    const buttonEl = document.getElementById(`previewBtn_${musicId}`);

    if (currentAudio && currentAudio !== audioEl) {
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio.style.display = "none";

      if (currentButton) {
        currentButton.innerHTML = `<i class="bi bi-music-note-beamed"></i> Preview`;
        currentButton.classList.remove("btn-danger");
        currentButton.classList.add("btn-outline-primary");
      }
    }

    if (!audioEl.src) {
      audioEl.src = musicUrl;
    }

    if (audioEl.paused) {
      audioEl.style.display = "block";
      audioEl.play();

      buttonEl.innerHTML = `<i class="bi bi-stop-circle"></i> Stop`;
      buttonEl.classList.remove("btn-outline-primary");
      buttonEl.classList.add("btn-danger");

      currentAudio = audioEl;
      currentButton = buttonEl;
    } else {
      audioEl.pause();
      audioEl.currentTime = 0;
      audioEl.style.display = "none";

      buttonEl.innerHTML = `<i class="bi bi-music-note-beamed"></i> Preview`;
      buttonEl.classList.remove("btn-danger");
      buttonEl.classList.add("btn-outline-primary");

      currentAudio = null;
      currentButton = null;
    }
  }

  async function loadMusic(page = 1) {
    const tbody = document.getElementById("musicTableBody");
    const modalContainer = document.getElementById("musicModals");
    const pageInfo = document.getElementById("pageInfo");

    // âœ… Show loading row
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
    modalContainer.innerHTML = "";

    try {
      const response = await fetch(`/admin/api/music-list?page=${page}&per_page=${perPage}&order=desc`);
      const data = await response.json();

      tbody.innerHTML = ""; // clear loading
      modalContainer.innerHTML = "";

      if (!data.music || data.music.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">No music found</td></tr>`;
        pageInfo.textContent = `Page ${page} | ${data.total_pages}`;
        return;
      }

      data.music.forEach((music, index) => {
        const modalIdEdit = `editModal${page}_${index}`;
        const modalIdDelete = `deleteModal${page}_${index}`;

        // âœ… Add table row
        tbody.innerHTML += `
        <tr>
          <td>${(page - 1) * perPage + (index + 1)}</td>
          <td>${music.title}</td>
          <td>${music.artist}</td>
          <td class="text-center">
            <button
              id="previewBtn_${music._id}"
              class="btn btn-sm btn-outline-primary"
              onclick="togglePreview('${music._id}', '${music.url}')">
              <i class="bi bi-music-note-beamed"></i> Preview
            </button>
            <audio id="audio_${music._id}" style="display:none; width:100%; margin-top:5px;"></audio>
          </td>
          <td class="text-center">
            <img src="${music.image}" alt="${music.title}" style="width: 60px; height: auto; border-radius:4px;">
          </td>
          <td>
            <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#${modalIdEdit}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#${modalIdDelete}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        `;

        // âœ… Add Edit modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdEdit}" tabindex="-1" aria-labelledby="${modalIdEdit}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdEdit}Label">Edit Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editForm${page}_${index}">
                  <div class="mb-3">
                    <label for="editTitle${page}_${index}" class="form-label">Title <span class="text-danger">*</label>
                    <input type="text" class="form-control" id="editTitle${page}_${index}" value="${music.title}">
                  </div>
                  <div class="mb-3">
                    <label for="editArtist${page}_${index}" class="form-label">Artist <span class="text-danger">*</label>
                    <input type="text" class="form-control" id="editArtist${page}_${index}" value="${music.artist}">
                  </div>
                  <div class="mb-3">
                  <label class="form-label">Music File (leave blank to keep current)</label>
                  <input type="file" class="form-control" id="editMusicFile${page}_${index}" accept="audio/*">
                </div>
                <!-- Desktop (Drag & Drop) -->
                <div class="mb-3 d-none d-md-block">
                  <label class="form-label">Image File (leave blank to keep current)</label>
                  <div id="editDropZone${page}_${index}" class="dropzone">
                    <p>Drag & Drop image here, or click to select</p>
                    <input type="file" id="editImageFile${page}_${index}" accept="image/*" hidden>
                  </div>
                </div>

                <!-- Mobile (Normal Input) -->
                <div class="mb-3 d-md-none">
                  <label class="form-label">Image File (leave blank to keep current)</label>
                  <input type="file" class="form-control" id="editImageFileMobile${page}_${index}" accept="image/*">
                </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button
                  type="button"
                  class="btn btn-primary"
                  id="editMusicBtn_${music._id}"
                  data-loading-text='<span class="spinner-border spinner-border-sm me-2"></span> Saving...'
                  onclick="updateMusic('${music._id}', 'editForm${page}_${index}')">Save changes</button>
              </div>
            </div>
          </div>
        </div>
        `;

        // âœ… Add Delete modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdDelete}" tabindex="-1" aria-labelledby="${modalIdDelete}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdDelete}Label">Delete Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete <strong>${music.title}</strong> by <em>${music.artist}</em>?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteMusic('${music._id}', '${modalIdDelete}')">Delete</button>
              </div>
            </div>
          </div>
        </div>
        `;

        setTimeout(() => {
          initDropZone(`editDropZone${page}_${index}`, `editImageFile${page}_${index}`);
        }, 0);
      });

      // âœ… Update page info
      pageInfo.textContent = `Page ${page} | ${data.total_pages}`;
      document.getElementById("prevPage").disabled = page <= 1;
      document.getElementById("nextPage").disabled = data.music.length < perPage;

    } catch (error) {
      console.error("Error fetching music list:", error);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>`;
    }
  }

  async function addMusic() {
    const btn = document.getElementById("addMusicBtn");
    setButtonLoading(btn, true);

    const title = document.getElementById("addTitle").value.trim();
    const artist = document.getElementById("addArtist").value.trim();
    const musicFile = document.getElementById("addMusicFile").files[0];
    const imageFileDesktop = document.getElementById("addImageFile").files[0];
    const imageFileMobile = document.getElementById("addImageFileMobile").files[0];
    const imageFile = imageFileDesktop || imageFileMobile;

    // âœ… Required field checks
    if (!title || !artist || !musicFile || !imageFile) {
      alert("All fields are required.");
      setButtonLoading(btn, false);
      return;
    }

    // âœ… File type validation
    if (!musicFile.type.startsWith("audio/")) {
      alert("Please upload a valid music file.");
      setButtonLoading(btn, false);
      return;
    }
    if (!imageFile.type.startsWith("image/")) {
      alert("Please upload a valid image file.");
      setButtonLoading(btn, false);
      return;
    }

    const formData = new FormData();
    formData.append("title", title);
    formData.append("artist", artist);
    formData.append("music_file", musicFile);
    formData.append("image_file", imageFile);

    try {
      const res = await fetch("/admin/api/add-music", { method: "POST", body: formData });

      if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById("addMusicModal")).hide();
        const data = await res.json();
        loadMusic(currentPage);
        alert(data.message);
      } else {
        alert("Failed to add music.");
      }
    } catch (err) {
      console.error(err);
      alert("Error adding music.");
    } finally {
      setButtonLoading(btn, false);
    }
  }

  async function updateMusic(musicId, formId) {
    const btn = document.getElementById(`editMusicBtn_${musicId}`);
    setButtonLoading(btn, true);

    const form = document.getElementById(formId);
    const title = form.querySelector(`#${formId} input[id^='editTitle']`).value.trim();
    const artist = form.querySelector(`#${formId} input[id^='editArtist']`).value.trim();
    const musicFile = form.querySelector(`#${formId} input[id^='editMusicFile']`).files[0];
    const imageFileDesktop = form.querySelector(`#${formId} input[id^='editImageFile']`).files[0];
    const imageFileMobile = form.querySelector(`#${formId} input[id^='editImageFileMobile']`).files[0];
    const imageFile = imageFileDesktop || imageFileMobile;

    // âœ… Required checks
    if (!title || !artist) {
      alert("Title and Artist are required.");
      setButtonLoading(btn, false);
      return;
    }

    // âœ… File type validation (only if provided)
    if (musicFile && !musicFile.type.startsWith("audio/")) {
      alert("Please upload a valid music file.");
      setButtonLoading(btn, false);
      return;
    }
    if (imageFile && !imageFile.type.startsWith("image/")) {
      alert("Please upload a valid image file.");
      setButtonLoading(btn, false);
      return;
    }

    const formData = new FormData();
    formData.append("title", title);
    formData.append("artist", artist);
    if (musicFile) formData.append("music_file", musicFile);
    if (imageFile) formData.append("image_file", imageFile);

    try {
      const res = await fetch(`/admin/api/update-music/${musicId}`, {
        method: "PUT",
        body: formData
      });

      if (res.ok) {
        bootstrap.Modal.getInstance(
          document.getElementById(form.closest(".modal").id)
        ).hide();

        const data = await res.json();
        loadMusic(currentPage);
        alert(data.message);
      } else {
        alert("Failed to update music.");
      }
    } catch (err) {
      console.error(err);
      alert("Error updating music.");
    } finally {
      // ðŸ”¹ Restore button
      setButtonLoading(btn, false);
    }
  }

  async function deleteMusic(musicId, modalId) {
    const res = await fetch(`/admin/api/delete-music/${musicId}`, { method: "DELETE" });

    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
      const data = await res.json();
      loadMusic(currentPage);
      alert(data.message);
    } else {
      alert("Failed to delete music.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadMusic(currentPage);
    initDropZone("addDropZone", "addImageFile");

    const addMusicModal = document.getElementById("addMusicModal");
    addMusicModal.addEventListener("show.bs.modal", () => {
      document.getElementById("addMusicForm").reset();

      // reset dropzone text
      const addDropZone = document.getElementById("addDropZone");
      if (addDropZone) {
        const p = addDropZone.querySelector("p");
        if (p) p.textContent = "Drag & Drop image here, or click to select";
      }
    });

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        loadMusic(currentPage);
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      loadMusic(currentPage);
    });
  });
</script>
{% endblock %}