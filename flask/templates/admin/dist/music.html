{% extends "admin/dist/layout.html" %}

{% block title %}Admin | Music{% endblock %}

{% block content %}
<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Music</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="/admin/dashboard">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">Maintenance</li>
          <li class="breadcrumb-item active" aria-current="page">Music</li>
        </ol>
      </div>
    </div>
  </div>
</div>
<div class="app-content">
  <div class="container-fluid">
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Music List</h3>
            <div class="mb-3 text-end">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMusicModal">
                <i class="bi bi-plus-circle"></i> Add Music
              </button>
            </div>
            <!-- Add Modal -->
            <div class="modal fade" id="addMusicModal" tabindex="-1" aria-labelledby="addMusicModalLabel"
              aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Add New Music</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="addMusicForm">
                      <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="addTitle" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Artist</label>
                        <input type="text" class="form-control" id="addArtist" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Music File</label>
                        <input type="file" class="form-control" id="addMusicFile" accept="audio/*" required>
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Image File</label>
                        <input type="file" class="form-control" id="addImageFile" accept="image/*" required>
                      </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addMusic()">Save</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <table class="table table-bordered table-hover">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Artist</th>
                  <th>Preview</th>
                  <th>Image</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="musicTableBody">
                <!-- Default loading row -->
                <tr>
                  <td colspan="6" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>

            <!-- âœ… Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <button id="prevPage" class="btn btn-outline-secondary btn-sm">Prev</button>
              <span id="pageInfo"></span>
              <button id="nextPage" class="btn btn-outline-secondary btn-sm">Next</button>
            </div>

            <div id="musicModals"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  const perPage = 10;

  async function loadMusic(page = 1) {
    const tbody = document.getElementById("musicTableBody");
    const modalContainer = document.getElementById("musicModals");
    const pageInfo = document.getElementById("pageInfo");

    // âœ… Show loading row
    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;
    modalContainer.innerHTML = "";

    try {
      const response = await fetch(`/admin/api/music-list?page=${page}&per_page=${perPage}&order=desc`);
      const data = await response.json();

      tbody.innerHTML = ""; // clear loading
      modalContainer.innerHTML = "";

      if (!data.music || data.music.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">No music found</td></tr>`;
        pageInfo.textContent = `Page ${page} | ${data.total_pages}`;
        return;
      }

      data.music.forEach((music, index) => {
        const modalIdEdit = `editModal${page}_${index}`;
        const modalIdDelete = `deleteModal${page}_${index}`;

        // âœ… Add table row
        tbody.innerHTML += `
        <tr>
          <td>${(page - 1) * perPage + (index + 1)}</td>
          <td>${music.title}</td>
          <td>${music.artist}</td>
          <td class="text-center">
            <a href="${music.url}" target="_blank" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-music-note-beamed"></i> Preview
            </a>
          </td>
          <td class="text-center">
            <img src="${music.image}" alt="${music.title}" style="width: 60px; height: auto; border-radius:4px;">
          </td>
          <td>
            <button class="btn btn-sm btn-primary me-1" data-bs-toggle="modal" data-bs-target="#${modalIdEdit}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#${modalIdDelete}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </td>
        </tr>
        `;

        // âœ… Add Edit modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdEdit}" tabindex="-1" aria-labelledby="${modalIdEdit}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdEdit}Label">Edit Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editForm${page}_${index}">
                  <div class="mb-3">
                    <label for="editTitle${page}_${index}" class="form-label">Title</label>
                    <input type="text" class="form-control" id="editTitle${page}_${index}" value="${music.title}">
                  </div>
                  <div class="mb-3">
                    <label for="editArtist${page}_${index}" class="form-label">Artist</label>
                    <input type="text" class="form-control" id="editArtist${page}_${index}" value="${music.artist}">
                  </div>
                  <div class="mb-3">
                  <label class="form-label">Music File (leave blank to keep current)</label>
                  <input type="file" class="form-control" id="editMusicFile${page}_${index}" accept="audio/*">
                </div>
                <div class="mb-3">
                  <label class="form-label">Image File (leave blank to keep current)</label>
                  <input type="file" class="form-control" id="editImageFile${page}_${index}" accept="image/*">
                </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateMusic('${music._id}', 'editForm${page}_${index}')">Save changes</button>
              </div>
            </div>
          </div>
        </div>
        `;

        // âœ… Add Delete modal
        modalContainer.innerHTML += `
        <div class="modal fade" id="${modalIdDelete}" tabindex="-1" aria-labelledby="${modalIdDelete}Label" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalIdDelete}Label">Delete Music</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete <strong>${music.title}</strong> by <em>${music.artist}</em>?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteMusic('${music._id}', '${modalIdDelete}')">Delete</button>
              </div>
            </div>
          </div>
        </div>
        `;
      });

      // âœ… Update page info
      pageInfo.textContent = `Page ${page} | ${data.total_pages}`;
      document.getElementById("prevPage").disabled = page <= 1;
      document.getElementById("nextPage").disabled = data.music.length < perPage;

    } catch (error) {
      console.error("Error fetching music list:", error);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>`;
    }
  }

  // ðŸ”¹ Add Music
  async function addMusic() {
    const formData = new FormData();
    formData.append("title", document.getElementById("addTitle").value);
    formData.append("artist", document.getElementById("addArtist").value);
    formData.append("music_file", document.getElementById("addMusicFile").files[0]);
    formData.append("image_file", document.getElementById("addImageFile").files[0]);

    const res = await fetch("/admin/api/add-music", {
      method: "POST",
      body: formData
    });

    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById("addMusicModal")).hide();
      const data = await res.json();
      loadMusic(currentPage);
      alert(data.message);
    } else {
      alert("Failed to add music.");
    }
  }

  // ðŸ”¹ Update Music
  async function updateMusic(musicId, formId) {
    const form = document.getElementById(formId);
    const formData = new FormData();
    formData.append("title", form.querySelector(`#${formId} input[id^='editTitle']`).value);
    formData.append("artist", form.querySelector(`#${formId} input[id^='editArtist']`).value);

    const musicFile = form.querySelector(`#${formId} input[id^='editMusicFile']`).files[0];
    if (musicFile) formData.append("music_file", musicFile);

    const imageFile = form.querySelector(`#${formId} input[id^='editImageFile']`).files[0];
    if (imageFile) formData.append("image_file", imageFile);

    const res = await fetch(`/admin/api/update-music/${musicId}`, {
      method: "PUT",
      body: formData
    });

    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById(form.closest(".modal").id)).hide();
      const data = await res.json();
      loadMusic(currentPage);
      alert(data.message);

    } else {
      alert("Failed to update music.");
    }
  }

  // ðŸ”¹ Delete Music
  async function deleteMusic(musicId, modalId) {
    const res = await fetch(`/admin/api/delete-music/${musicId}`, { method: "DELETE" });

    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById(modalId)).hide();
      const data = await res.json();
      loadMusic(currentPage);
      alert(data.message);
    } else {
      alert("Failed to delete music.");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadMusic(currentPage);

    document.getElementById("prevPage").addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        loadMusic(currentPage);
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
      currentPage++;
      loadMusic(currentPage);
    });
  });
</script>
{% endblock %}